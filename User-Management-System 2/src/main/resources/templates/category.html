<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Category Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Arial', sans-serif; }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        h2, h3 { color: #343a40; text-align: center; }
        .btn { border-radius: 20px; }
        .table { margin-top: 20px; border-radius: 10px; overflow: hidden; }
        .form-container { padding: 20px; border-radius: 10px; background: #f1f1f1; }
        .backButton {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    position: fixed;
    bottom: 20px;
    right: 20px;
}

.backButton:hover {
    background-color: #5a6268;
}

    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center">Category Management</h2>

    <!-- Create Category Form -->
    <form id="createCategoryForm" class="form-container shadow-sm mb-4">
        <div class="mb-3">
            <label for="categoryName" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="categoryName" required>
        </div>
        <div class="mb-3">
            <label for="categoryDesc" class="form-label">Category Description</label>
            <textarea class="form-control" id="categoryDesc" rows="3"></textarea>
        </div>
        <button type="button" class="btn btn-primary w-100" onclick="createCategory()">Save Category</button>
    </form>

    <!-- Search & Filter Section -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="searchCategoryName" class="form-control w-25" placeholder="Search Category Name">
        <input type="text" id="searchCategoryDesc" class="form-control w-25" placeholder="Search Category Description">

        <select id="sortField" class="form-select w-25">
            <option value="uniqueId">Sort by ID</option>
            <option value="categoryName">Sort by Name</option>
        </select>

        <select id="sortDirection" class="form-select w-25">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
        </select>

        <input type="number" id="pageSize" class="form-control w-25" placeholder="Page Size (e.g. 5, 10, 20)" min="1">
        <input type="number" id="pageNumber" class="form-control w-25" placeholder="Page Number (e.g. 0, 1, 2)" min="0">

        <button class="btn btn-primary" id="fetchCategories">Search</button>
    </div>

    <!-- Categories Table -->
    <table class="table table-hover table-bordered bg-white text-center">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Category Name</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="categoryTableBody">
        <tr th:each="category : ${categories}">
            <td th:text="${category.uniqueId}"></td>
            <td th:text="${category.categoryName}"></td>
            <td th:text="${category.categoryDesc}"></td>
            <td>
                <button type="button" class="btn btn-warning btn-sm"
                        th:attr="data-id=${category.uniqueId}, data-name=${category.categoryName}, data-desc=${category.categoryDesc}"
                        onclick="openEditForm(this)">
                    Edit
                </button>
                <a th:href="@{/category/delete/{id}(id=${category.uniqueId})}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <!-- Dynamic Pagination Controls -->
    <div id="paginationControls" class="d-flex justify-content-center mt-3"></div>

    <nav>
        <ul class="pagination justify-content-center">
            <!-- Previous Button -->
            <li class="page-item" th:classappend="${page == 0} ? 'disabled'">
                <button class="page-link"
                        th:disabled="${page == 0}"
                        th:attr="onclick=${page > 0} ? 'fetchCategories(' + (${page - 1}) + ');' : null">
                    Previous
                </button>
            </li>


            <!-- Page Number Buttons -->
            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${page == i} ? 'active'">
                <button class="page-link" th:attr="onclick='fetchCategories(' + ${i} + ');'" th:text="${i + 1}"></button>
            </li>

            <!-- Next Button -->
            <li class="page-item" th:classappend="${page == totalPages - 1} ? 'disabled'">
                <button class="page-link" th:attr="onclick='fetchCategories(' + (${page + 1}) + ');'" th:disabled="${page == totalPages - 1}">Next</button>
            </li>
        </ul>

    </nav>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" class="modal fade" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="editCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryDesc" class="form-label">Category Description</label>
                        <textarea class="form-control" id="editCategoryDesc" rows="3"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="updateCategory()">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3"></div>
<button class="backButton" onclick="goBack()">← Back</button>


<script>
    function goBack() {
  window.history.back();
}
  // Toast Message Functionality
  function showToast(message, isError = false) {
      let toastContainer = document.getElementById("toastContainer");
      let toastHTML = `
          <div class="toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0 show" role="alert">
              <div class="d-flex">
                  <div class="toast-body">${message}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div>
          </div>
      `;
      toastContainer.innerHTML = toastHTML;
      let toastElement = document.querySelector(".toast");
      let toast = new bootstrap.Toast(toastElement);
      toast.show();
  }

  // Create Category Function
  function createCategory() {
      let categoryData = {
          categoryName: document.getElementById("categoryName").value,
          categoryDesc: document.getElementById("categoryDesc").value
      };

      fetch('/category', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(categoryData)
      })
      .then(response => response.json())
      .then(data => {
          showToast("Category created successfully!");
          setTimeout(() => location.reload(), 1500);
      })
      .catch(error => {
          console.error('Error:', error);
          showToast("Error creating category", true);
      });
  }

  // Open Edit Modal and Pre-fill Data
  function openEditForm(button) {
      document.getElementById("editCategoryId").value = button.getAttribute("data-id") || "";
      document.getElementById("editCategoryName").value = button.getAttribute("data-name") || "";
      document.getElementById("editCategoryDesc").value = button.getAttribute("data-desc") || "";
      let modal = new bootstrap.Modal(document.getElementById("editCategoryModal"));
      modal.show();
  }

  // Update Category Function
  function updateCategory() {
      let categoryData = {
          uniqueId: document.getElementById("editCategoryId").value,
          categoryName: document.getElementById("editCategoryName").value,
          categoryDesc: document.getElementById("editCategoryDesc").value
      };

      fetch('/category', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(categoryData)
      })
      .then(response => response.text())
      .then(data => {
          showToast("Category updated successfully!");
          setTimeout(() => location.reload(), 1500);
      })
      .catch(error => {
          console.error('Error:', error);
          showToast("Error updating category", true);
      });
  }
 function fetchCategories(page = 0) {
  let size = document.getElementById("pageSize").value || 5;
  let field = document.getElementById("sortField").value;
  let order = document.getElementById("sortDirection").value;
  let categoryName = document.getElementById("searchCategoryName").value;
  let categoryDesc = document.getElementById("searchCategoryDesc").value;

  let url = `/category?page=${page}&size=${size}&order=${order}&field=${field}&categoryName=${categoryName}&categoryDesc=${categoryDesc}`;

  fetch(url)
      .then(response => response.text())
      .then(html => {
          let parser = new DOMParser();
          let doc = parser.parseFromString(html, "text/html");

          // Update Table
          let tableBody = document.getElementById("categoryTableBody");
          tableBody.innerHTML = doc.querySelector("#categoryTableBody").innerHTML;

          // Get total pages dynamically
          let totalPages = parseInt(doc.querySelector("#totalPages").textContent.trim());

          // ✅ Update pagination dynamically
          updatePaginationControls(page, totalPages);
      })
      .catch(error => console.error("Error fetching categories:", error));
}

function updatePaginationControls(currentPage, totalPages) {
  let paginationContainer = document.querySelector(".pagination");
  paginationContainer.innerHTML = ""; // Clear old pagination

  // ✅ Previous Button
  let prevDisabled = currentPage === 0 ? "disabled" : "";
  let prevOnClick = currentPage > 0 ? `onclick="fetchCategories(${currentPage - 1})"` : "";

  let prevButton = `
      <li class="page-item ${prevDisabled}">
          <button class="page-link" ${prevOnClick} ${prevDisabled}>Previous</button>
      </li>`;
  paginationContainer.innerHTML += prevButton;

  // ✅ Page Number Buttons
  for (let i = 0; i < totalPages; i++) {
      let activeClass = currentPage === i ? "active" : "";
      paginationContainer.innerHTML += `
          <li class="page-item ${activeClass}">
              <button class="page-link" onclick="fetchCategories(${i})">${i + 1}</button>
          </li>`;
  }

  // ✅ Next Button
  let nextDisabled = currentPage === totalPages - 1 ? "disabled" : "";
  let nextOnClick = currentPage < totalPages - 1 ? `onclick="fetchCategories(${currentPage + 1})"` : "";

  let nextButton = `
      <li class="page-item ${nextDisabled}">
          <button class="page-link" ${nextOnClick} ${nextDisabled}>Next</button>
      </li>`;
  paginationContainer.innerHTML += nextButton;
}


// ✅ Load categories when page loads
document.addEventListener("DOMContentLoaded", function () {
  fetchCategories();  // Start from page 0
  document.getElementById("fetchCategories").addEventListener("click", () => fetchCategories());
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
